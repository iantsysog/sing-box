name: Sync
permissions:
  contents: write
  actions: write
on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:
    inputs:
      sync:
        description: "Sync"
        type: boolean
        default: true
      build:
        description: "Build type"
        required: true
        type: choice
        default: "ALL"
        options:
          - ALL
          - Binary
          - macOS
          - iOS
          - SKIP
      version:
        description: "Version"
        type: string
        required: false
concurrency:
  group: sing-box
  cancel-in-progress: true
env:
  UPSTREAM_REPO: "SagerNet/sing-box"
  UPSTREAM_BRANCH: "dev-next"
jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.out.outputs.should_sync }}
      build_types: ${{ steps.out.outputs.build_types }}
      is_schedule: ${{ steps.out.outputs.is_schedule }}
    steps:
      - id: out
        shell: bash
        run: |
          event_name="${{ github.event_name }}"
          sync_val="${{ inputs.sync || 'true' }}"
          mode_val="${{ inputs.build || 'ALL' }}"

          if [[ "$event_name" == "schedule" ]]; then
            printf 'is_schedule=true\n' >> "$GITHUB_OUTPUT"
            printf 'should_sync=true\n' >> "$GITHUB_OUTPUT"
          else
            printf 'is_schedule=false\n' >> "$GITHUB_OUTPUT"
            if [[ "$sync_val" == "true" ]]; then
              printf 'should_sync=true\n' >> "$GITHUB_OUTPUT"
            else
              printf 'should_sync=false\n' >> "$GITHUB_OUTPUT"
            fi
          fi

          case "$mode_val" in
            ALL) printf 'build_types=["binary","macos","ios"]\n' >> "$GITHUB_OUTPUT" ;;
            Binary) printf 'build_types=["binary"]\n' >> "$GITHUB_OUTPUT" ;;
            macOS) printf 'build_types=["macos"]\n' >> "$GITHUB_OUTPUT" ;;
            iOS) printf 'build_types=["ios"]\n' >> "$GITHUB_OUTPUT" ;;
            *) printf 'build_types=[]\n' >> "$GITHUB_OUTPUT" ;;
          esac
  sync:
    if: needs.plan.outputs.should_sync == 'true'
    runs-on: ubuntu-latest
    needs: plan
    outputs:
      changes: ${{ steps.sync.outputs.changes }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          ref: main
          submodules: recursive
      - run: |
          sudo apt-get update
          sudo apt-get install -y rsync
      - run: git submodule update --init --recursive
      - id: sync
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global advice.detachedHead false

          TEMP_DIR=$(mktemp -d)
          git clone --depth=1 --branch="${UPSTREAM_BRANCH}" "https://github.com/${UPSTREAM_REPO}.git" "$TEMP_DIR"

          up_sha=$(git -C "$TEMP_DIR" rev-parse HEAD)

          rm -rf "$TEMP_DIR/.git" "$TEMP_DIR/.github"
          rsync -av --delete --exclude='.git' --exclude='clients' "$TEMP_DIR/" "src/"
          rm -rf "$TEMP_DIR"

          git submodule update --remote --recursive
          git add .

          if git diff-index --quiet HEAD --; then
            printf 'changes=false\n' >> "$GITHUB_OUTPUT"
          else
            git commit -m "feat: bump ${up_sha:0:7} [$(date -u +%FT%TZ)]"
            git remote set-url origin "https://user:${{ secrets.PAT }}@github.com/${{ github.repository }}.git"
            git push --force-with-lease origin HEAD:main
            printf 'changes=true\n' >> "$GITHUB_OUTPUT"
          fi
  build-binary:
    if: |
      always() &&
      contains(needs.plan.outputs.build_types, 'binary') &&
      (needs.plan.outputs.is_schedule == 'false' || needs.sync.outputs.changes == 'true')
    runs-on: macos-latest
    needs: [plan, sync]
    strategy:
      matrix:
        include:
          - {arch: amd64}
          - {arch: arm64}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-go@v6
        with:
          go-version: "^1.25.3"
          cache: true
      - working-directory: src
        continue-on-error: true
        run: |
          VERSION="${{ inputs.version || github.sha }}"
          TAGS="with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,with_ocm,with_naive_outbound,badlinkname,tfogo_checklinkname0"

          export GOTOOLCHAIN=local
          go build -v -trimpath \
            -ldflags="-s -buildid= -X github.com/sagernet/sing-box/constant.Version=$VERSION -X internal/godebug.defaultGODEBUG=multipathtcp=0 -checklinkname=0" \
            -tags="$TAGS" \
            -o sing-box \
            ./cmd/sing-box
        env:
          CGO_ENABLED: "1"
          GOOS: darwin
          GOARCH: ${{ matrix.arch }}
      - working-directory: src
        run: |
          VERSION="${{ inputs.version || github.sha }}"
          PKG="sing-box-${VERSION}-darwin-${{ matrix.arch }}"
          mkdir "$PKG"
          cp LICENSE sing-box "$PKG/"

          if ! command -v zstd >/dev/null 2>&1; then
            brew install zstd gnu-tar
          fi

          gtar --zstd -cf "${PKG}.tar.zst" "$PKG"
      - uses: actions/upload-artifact@v6
        with:
          name: binary-darwin-${{ matrix.arch }}
          path: src/*.tar.zst
          retention-days: 7
          if-no-files-found: ignore
  build-macos:
    if: |
      always() &&
      contains(needs.plan.outputs.build_types, 'macos') &&
      (needs.plan.outputs.is_schedule == 'false' || needs.sync.outputs.changes == 'true')
    runs-on: macos-26
    needs: [plan, sync]
    strategy:
      matrix:
        include:
          - {name: apple, arch: arm64}
          - {name: intel, arch: x86_64}
          - {name: universal, arch: universal}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-go@v6
        with:
          go-version: "^1.25.3"
          cache: true
      - working-directory: src
        continue-on-error: true
        run: |
          if [[ ! -d "clients/apple" ]]; then
            exit 0
          fi

          if ! command -v create-dmg >/dev/null 2>&1; then
            brew install create-dmg zstd gnu-tar
          fi

          make lib_install
          export PATH="$PATH:$(go env GOPATH)/bin"

          go run ./cmd/internal/build_libbox -target apple -platform macos
          mv Libbox.xcframework clients/apple/

          cd clients/apple

          if [[ ! -f "sing-box.xcodeproj/project.pbxproj" ]]; then
            exit 0
          fi

          sed -i '' \
            -e 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' \
            -e 's/CODE_SIGN_IDENTITY = .*/CODE_SIGN_IDENTITY = "-";/g' \
            -e 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' \
            sing-box.xcodeproj/project.pbxproj

          VERSION="${{ inputs.version || github.sha }}"
          DMG="SFM-${{ matrix.name }}-${VERSION}.dmg"

          if [[ "${{ matrix.arch }}" == "universal" ]]; then
            ARCH_OPTS=""
          else
            ARCH_OPTS="ARCHS=${{ matrix.arch }}"
          fi

          xcodebuild build \
            -scheme SFM.System \
            -configuration Release \
            -destination "generic/platform=macOS" \
            -derivedDataPath ./DD \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            -skipPackagePluginValidation \
            $ARCH_OPTS

          APP=$(find . -name "*.app" -type d -print -quit)

          if [[ -z "$APP" ]]; then
            exit 0
          fi

          create-dmg \
            --volname "SFM" \
            --app-drop-link 200 200 \
            --skip-jenkins \
            "$DMG" \
            "$APP"

          mv "$DMG" ../../
          cd ../..
          gtar --zstd -cf "${DMG}.tar.zst" "$DMG"
      - uses: actions/upload-artifact@v6
        with:
          name: macos-${{ matrix.name }}
          path: src/*.tar.zst
          retention-days: 7
          if-no-files-found: ignore
  build-ios:
    if: |
      always() &&
      contains(needs.plan.outputs.build_types, 'ios') &&
      (needs.plan.outputs.is_schedule == 'false' || needs.sync.outputs.changes == 'true')
    runs-on: macos-26
    needs: [plan, sync]
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-go@v6
        with:
          go-version: "^1.25.3"
          cache: true
      - working-directory: src
        continue-on-error: true
        run: |
          if [[ ! -d "clients/apple" ]]; then
            exit 0
          fi

          if ! command -v ldid >/dev/null 2>&1; then
            brew install ldid zstd gnu-tar
          fi

          make lib_install
          export PATH="$PATH:$(go env GOPATH)/bin"

          go run ./cmd/internal/build_libbox -target apple -platform ios
          mv Libbox.xcframework clients/apple/

          cd clients/apple

          if [[ ! -f "sing-box.xcodeproj/project.pbxproj" ]]; then
            exit 0
          fi

          VERSION="${{ inputs.version || github.sha }}"
          export XCODEPROJ_NAME=sing-box
          export APPLICATION_NAME=sing-box
          export SCHEME_NAME=SFI

          xcodebuild \
            -project $XCODEPROJ_NAME.xcodeproj \
            -scheme $SCHEME_NAME \
            -destination 'generic/platform=iOS' \
            -configuration Debug \
            -sdk iphoneos \
            build install \
            STRIP_INSTALLED_PRODUCT=NO \
            ARCHS=arm64 \
            CODE_SIGNING_ALLOWED=NO \
            ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=NO \
            ENABLE_BITCODE=NO \
            DSTROOT=packages/

          ldid -SSFI/SFI.entitlements packages/Applications/$APPLICATION_NAME.app/$APPLICATION_NAME
          ldid -SExtension/Extension.entitlements packages/Applications/$APPLICATION_NAME.app/PlugIns/Extension.appex/Extension
          ldid -SIntentsExtension/IntentsExtension.entitlements packages/Applications/$APPLICATION_NAME.app/Extensions/IntentsExtension.appex/IntentsExtension

          mkdir -p packages/Payload
          cp -rp packages/Applications/$APPLICATION_NAME.app packages/Payload
          cd packages
          zip -qr $APPLICATION_NAME.tipa Payload
          mv $APPLICATION_NAME.tipa ../../${APPLICATION_NAME}-${VERSION}.tipa
          cd ../..

          gtar --zstd -cf "sing-box-${VERSION}-ios.tipa.tar.zst" "sing-box-${VERSION}.tipa"
      - uses: actions/upload-artifact@v6
        with:
          name: ios-tipa
          path: src/*.tipa.tar.zst
          retention-days: 7
          if-no-files-found: ignore
