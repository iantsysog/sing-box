name: Sync
permissions:
  contents: write
  actions: write
on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:
    inputs:
      sync:
        description: "Sync"
        type: boolean
        default: true
      build:
        description: "Build type"
        required: true
        type: choice
        default: "ALL"
        options:
          - ALL
          - Binary
          - macOS
          - SKIP
      version:
        description: "Version"
        type: string
        required: false
concurrency:
  group: sing-box
  cancel-in-progress: true
env:
  UPSTREAM_REPO: "SagerNet/sing-box"
  UPSTREAM_BRANCH: "dev-next"
jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.out.outputs.should_sync }}
      build_types: ${{ steps.out.outputs.build_types }}
      is_schedule: ${{ steps.out.outputs.is_schedule }}
    steps:
      - id: out
        shell: bash
        run: |
          event_name="${{ github.event_name }}"
          sync_val="${{ inputs.sync || 'true' }}"
          mode_val="${{ inputs.build || 'ALL' }}"

          if [[ "$event_name" == "schedule" ]]; then
            printf 'is_schedule=true\n' >> "$GITHUB_OUTPUT"
            printf 'should_sync=true\n' >> "$GITHUB_OUTPUT"
          else
            printf 'is_schedule=false\n' >> "$GITHUB_OUTPUT"
            if [[ "$sync_val" == "true" ]]; then
              printf 'should_sync=true\n' >> "$GITHUB_OUTPUT"
            else
              printf 'should_sync=false\n' >> "$GITHUB_OUTPUT"
            fi
          fi

          case "$mode_val" in
            ALL) printf 'build_types=["binary","macos"]\n' >> "$GITHUB_OUTPUT" ;;
            Binary) printf 'build_types=["binary"]\n' >> "$GITHUB_OUTPUT" ;;
            macOS) printf 'build_types=["macos"]\n' >> "$GITHUB_OUTPUT" ;;
            *) printf 'build_types=[]\n' >> "$GITHUB_OUTPUT" ;;
          esac
  sync:
    if: needs.plan.outputs.should_sync == 'true'
    runs-on: ubuntu-latest
    needs: plan
    outputs:
      changes: ${{ steps.sync.outputs.changes }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          ref: main
          submodules: recursive
      - run: |
          sudo apt-get update
          sudo apt-get install -y rsync
      - run: git submodule update --init --recursive
      - id: sync
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global advice.detachedHead false

          TEMP_DIR=$(mktemp -d)
          git clone --depth=1 --branch="${UPSTREAM_BRANCH}" "https://github.com/${UPSTREAM_REPO}.git" "$TEMP_DIR"

          up_sha=$(git -C "$TEMP_DIR" rev-parse HEAD)

          rm -rf "$TEMP_DIR/.git" "$TEMP_DIR/.github"
          rsync -av --delete --exclude='.git' --exclude='clients' "$TEMP_DIR/" "src/"
          rm -rf "$TEMP_DIR"

          git submodule update --remote --recursive
          git add .

          if git diff-index --quiet HEAD --; then
            printf 'changes=false\n' >> "$GITHUB_OUTPUT"
          else
            git commit -m "feat: bump ${up_sha:0:7} [$(date -u +%FT%TZ)]"
            git remote set-url origin "https://user:${{ secrets.PAT }}@github.com/${{ github.repository }}.git"
            git push --force-with-lease origin HEAD:main
            printf 'changes=true\n' >> "$GITHUB_OUTPUT"
          fi
  build-binary:
    if: |
      always() &&
      contains(needs.plan.outputs.build_types, 'binary') &&
      (needs.plan.outputs.is_schedule == 'false' || needs.sync.outputs.changes == 'true')
    runs-on: macos-latest
    needs: [plan, sync]
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-go@v6
        with:
          go-version: "^1.25.3"
          cache: true
      - working-directory: src
        continue-on-error: true
        run: |
          VERSION="${{ inputs.version || github.sha }}"
          TAGS="with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,with_ocm,badlinkname,tfogo_checklinkname0"

          go build -trimpath \
            -ldflags="-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=$VERSION" \
            -tags="$TAGS" \
            -o sing-box \
            ./cmd/sing-box

          PKG="sing-box-${VERSION}-${{ runner.os }}-$(go env GOARCH)"
          mkdir "$PKG"
          cp LICENSE sing-box "$PKG/"

          if ! command -v zstd >/dev/null 2>&1; then
            brew install zstd gnu-tar
          fi

          gtar --zstd -cf "${PKG}.tar.zst" "$PKG"
      - uses: actions/upload-artifact@v6
        with:
          name: binary
          path: src/*.tar.zst
          retention-days: 7
          if-no-files-found: ignore
  build-macos:
    if: |
      always() &&
      contains(needs.plan.outputs.build_types, 'macos') &&
      (needs.plan.outputs.is_schedule == 'false' || needs.sync.outputs.changes == 'true')
    runs-on: macos-26
    needs: [plan, sync]
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-go@v6
        with:
          go-version: "^1.25.3"
          cache: true
      - working-directory: src
        continue-on-error: true
        run: |
          if [[ ! -d "clients/apple" ]]; then
            exit 0
          fi

          if ! command -v create-dmg >/dev/null 2>&1; then
            brew install create-dmg zstd gnu-tar
          fi

          make lib_install
          export PATH="$PATH:$(go env GOPATH)/bin"

          go run ./cmd/internal/build_libbox -target apple -platform macos
          mv Libbox.xcframework clients/apple/

          cd clients/apple

          if [[ ! -f "sing-box.xcodeproj/project.pbxproj" ]]; then
            exit 0
          fi

          sed -i '' \
            -e 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' \
            -e 's/CODE_SIGN_IDENTITY = .*/CODE_SIGN_IDENTITY = "";/g' \
            -e 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' \
            sing-box.xcodeproj/project.pbxproj

          xcodebuild build \
            -scheme SFM.System \
            -configuration Release \
            -destination "generic/platform=macOS" \
            -derivedDataPath ./DD \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            -skipPackagePluginValidation

          APP=$(find . -name "*.app" -type d -print -quit)

          if [[ -z "$APP" ]]; then
            exit 0
          fi

          VERSION="${{ inputs.version || github.sha }}"
          DMG="SFM-${VERSION}.dmg"

          create-dmg \
            --volname "SFM" \
            --app-drop-link 200 200 \
            --skip-jenkins \
            "$DMG" \
            "$APP"

          mv "$DMG" ../../
          cd ../..
          gtar --zstd -cf "${DMG}.tar.zst" "$DMG"
      - uses: actions/upload-artifact@v6
        with:
          name: macos
          path: src/*.tar.zst
          retention-days: 7
          if-no-files-found: ignore
